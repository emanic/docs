// WE PULL THIS CONTENT FROM https://github.com/aporeto-inc/junon
// DO NOT EDIT THIS FILE.
// YOU MUST SUBMIT A PR AGAINST THE UPSTREAM REPO.
// THE UPSTREAM REPO IS CURRENTLY PRIVATE.

== Add Segment Consoles

=== About adding Segment Consoles

To scale horizontally, you can deploy more than one Segment Console and
configure them to trust each other. In this section, we guide you
through the process using two example Segment Consoles.

* Segment Console A, managed by Annette, with the address
`104.196.244.75.xip.io`
* Segment Console B, managed by Bob, with the address
`34.82.153.238.xip.io`

Annette and Bob both work for Acme, Inc. Both Segment Consoles use
`acme` as the account name and `/acme` as their root namespace.

NOTE: Though the examples use `xip.io` addresses, we do not recommend
these in production environments.

=== Prerequisites

* At least two Segment Consoles (we’ll refer to these as Segment Console
A and Segment Console B)
* At least one enforcer on each Segment Console (we’ll refer to these as
enforcer A and enforcer B)
* Firewalls must allow pass-through communications and not modify any
packets

=== Set up test images

[arabic]
. Access the enforcer A host, such as via SSH.
. Use the following command to spin up an nginx web server listening on
any IP address over port 80.
+
[source,console]
----
sudo docker run --rm -d -p 80:80 nginx
----
. Open the web interface of Segment Console A and confirm that the web
server shows up as a processing unit.
. Access the enforcer B host, such as via SSH.
. Use the following command to spin up a `centos` image.
+
[source,console]
----
sudo docker run -it centos
----
. Attempt to curl the nginx web server in Segment Console A, using
`http` and the public IP address of the enforcer A host.
+
[source,console]
----
curl http://54.65.32.1
----
. It should time out after a while.
+
[source,console]
----
curl: (7) Failed to connect to 54.65.32.1 port 80: Connection timed out
----
. Open the web interface of Segment Console B and select *Platform*. You
should see the processing unit representing the `centos` image, but no
record of the request.
. Open the web interface of Segment Console A and select *Platform*. You
should see the processing unit representing the `nginx` image. When you
click on it, you should see the record of the request under the *Access*
tab, denied due to `token (The token was invalid.)`.
+
image::fed-initial.gif[width=800]

NOTE: Observe the `$controller` tags in the metadata of the `nginx` and
`centos` images. These identify the Segment Console that they belong to.
We’ll use these later on to enable communications between the Segment
Consoles.

=== Configuring Segment Consoles to trust each other

[arabic]
. Copy the certificate of Segment Console A: open the *Account* page in
the web interface, scroll down to the *Namespace Certificate Authority*
section, and click *Copy to clipboard*.
+
image::fed-cp-copy-cert.gif[width=800]
. Paste the certificate into a file and save it with a PEM extension.
. Configure Segment Console B to trust the certificate of Segment
Console A: open the web interface of Segment Console B, make sure you’re
in the root namespace, expand *Namespace Settings*, select *Trusted
Namespace*, click *Create*, drag the certificate of the first Segment
Console into the *Certificate Authority* field, name the trusted
namespace, and click *Create*.
+
image::fed-cp-paste-cert.gif[width=800]
. Repeat these steps in reverse, copying the certificate of Segment
Console B and adding it to Segment Console A as trusted. In the
following example, we copy Bob’s certificate, open Annette’s Segment
Console, and trust Bob’s certificate.
+
image::fed-cp-cert-repeat.gif[width=800]

=== Verifying the trusted relationship

[arabic]
. Access the enforcer B host again.
. If necessary launch a new `centos` image.
+
[source,console]
----
sudo docker run -it centos
----
. From inside the `centos` container, attempt again to curl the nginx
web server in Segment Console A.
+
[source,console]
----
curl http://54.65.32.1
----
. It should time out again.
+
[source,console]
----
curl: (7) Failed to connect to 54.65.32.1 port 80: Connection timed out
----
. Open the web interface of Segment Console B and select *Platform*. You
should see the processing unit representing the `centos` image, but
still no record of the request.
. Open the web interface of Segment Console A and select *Platform*. You
should now see a failed flow from Segment Console B to the `nginx`
image. Clicking for more details, you see that the reason for the denial
was Segment’s default deny policy.
+
image::fed-trusted.gif[width=800]

Your Segment Consoles now recognize and trust each other, but processing
units in one cannot communicate with processing units in the other. You
must create network policies to allow this traffic.

=== Allowing the Segment Consoles to communicate

In the following exercise, we create network policies in both Segment
Consoles to allow our `centos` image to communicate with the `nginx`
image.

[arabic]
. In the web interface of Segment Console A, expand *Network
authorization*, select *Network policies*, and click the *Create*
button.
. Type a descriptive name such as
`Allow nginx in A to communicate with centos in B` and click *Next*.
. In the *Source* pane, type the controller tag of Segment Console B and
press ENTER. In our example, this has the tag
`$controller=34.82.153.238.xip.io`. Then type `$image=centos` and press
ENTER. Confirm that the two tags are connected by an `and`.
. Click *Next*.
. In the *Destination* pane, type the controller tag of Segment Console
A and press ENTER. In our example, the tag is
`$controller=104.196.244.75.xip.io`. Then type `$image=nginx` and press
ENTER. Confirm that the two tags are connected by an `and`.
. Click *Next*, then click *Create*.
. Open the web interface of Segment Console B, expand *Network
authorization*, select *Network policies*, and click the *Create*
button.
. Type a descriptive name such as
`Allow nginx in A to communicate with centos in B` and click *Next*.
. In the *Source* pane, type the controller tag of Segment Console B and
press ENTER. In our example, this has the tag
`$controller=34.82.153.238.xip.io`. Then type `$image=centos` and press
ENTER. Confirm that the two tags are connected by an `and`.
. Click *Next*.
. In the *Destination* pane, type the controller tag of Segment Console
A and press ENTER. In our example, the tag is
`$controller=104.196.244.75.xip.io`. Then type `$image=nginx` and press
ENTER. Confirm that the two tags are connected by an `and`.
. Click *Next*, then click *Create*.

=== Verifying the communications

[arabic]
. Access the enforcer B host again.
. If necessary launch a new `centos` image.
+
[source,console]
----
sudo docker run -it centos
----
. From inside the `centos` container, attempt again to curl the nginx
web server in Segment Console A.
+
[source,console]
----
curl http://54.65.32.1
----
. It should return the nginx welcome page.
+
[source,console]
----
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>

<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br/>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html>
----
. Open the web interface of Segment Console B and select *Platform*. You
should see the processing unit representing the `centos` image, but
still no record of the request.
. Open the web interface of Segment Console A and select *Platform*. You
should now see an allowed flow from Segment Console B to the `nginx`
image. Clicking for more details, you see that the policy you created
was applied.
+
image::fed-allowed.gif[width=800]
