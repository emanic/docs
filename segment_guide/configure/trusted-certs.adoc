// WE PULL THIS CONTENT FROM https://github.com/aporeto-inc/junon
// DO NOT EDIT THIS FILE.
// YOU MUST SUBMIT A PR AGAINST THE UPSTREAM REPO.
// THE UPSTREAM REPO IS CURRENTLY PRIVATE.

== Using trusted certificates

=== About Segment Console certificates

Each Segment Console deployment includes its own unique certificate
authority (CA). Clients connecting to Segment Console will not recognize
or trust your Segment Console CA by default. This includes web browsers,
`apoctl`, and clients of the Segment Console API. Users receive warning
messages that they must manually override.

Rather than configure each of these clients to trust your Segment
Console CA, you may wish to supply Segment Console with certificates
that the clients already trust.

TIP: While we recommend purchasing a certificate from a third party, you
can also use https://letsencrypt.org/[Let’s Encrypt] and
link:#using-let-s-encrypt-certificates[we provide instructions below].

IMPORTANT: Changing the Segment Console certificate requires Segment
Console to restart. Clients of Segment Console won’t be able to connect
during the restart. You may wish to notify your users ahead of time and
schedule this during a maintenance window.

The procedure differs according to what you used to launch Segment
Console.

* link:#configuring-trusted-certificates-on-kubernetes[Kubernetes]
* link:#configuring-trusted-certificates-on-docker[Docker]

=== Configuring trusted certificates on Kubernetes

TO DO

=== Configuring trusted certificates on Docker

[arabic]
. Access the Segment Console host.
. Save the certificate, its private key, and the certificate of the
certificate authority under the following names.
* `public-ca.pem`: the certificate of the certificate authority.
* `public-cert.pem`: the certificate of the web server, concatenated
with any intermediate certificates. The intermediate certificate(s) must
follow the web server’s certificate.
* `public-key.pem`: the private key of the certificate. Cannot be
password protected.
. Create an environment variable containing the path to the certificate
and key files. In the following example, we use a Let’s Encrypt path.
+
[source,console]
----
export CERT_PATH=/etc/letsencrypt/live/104.196.244.75.xip.io/
----
. Set an environment variable containing the routable IP address or
domain of Segment Console. Examples follow.
* *FQDN*
+
[source,console]
----
export ADDRESS=https://segment.acme.com
echo $ADDRESS
----
* *IP address*
+
[source,console]
----
export ADDRESS=https://104.196.244.75
echo $ADDRESS
----
. Use the following command to relaunch the Segment Console container.
+
[source,console]
----
sudo docker run -d --name=segment-console \
       --restart always \
       -e APORETO_CONSOLE_URL=$ADDRESS \
       -p 443:1443 -p 4443:4443 \
       -v /home/$USER/aporeto:/aporeto-data \
       -v $CERT_PATH:/custom-certs \
       gcr.io/aporetodev/console:master-staging
----
+
NOTE: This command assumes that you used the defaults during the
original installation. Otherwise, you must modify the command as needed.
. Check the logs.
+
[source,console]
----
sudo docker logs console
----
+
It should return something like the following.
+
[source,console]
----
Backend  v1.1378.0 (1befe075fca0d7641061b16a9a5d8869da179bb7) master Frontend v1.1141.0 (45bc8cd5261391f486a098ef4393cc15c171ca7d)
Loading  configuration  1s
Starting databases      3s
[WARNING] No volume mounted on /backup. Backups are disabled.
Starting services       22s
[READY] Aporeto is now up and accessible through https://segment.acme.com
----
+
TIP: If you don’t see the `READY` message, rerun the command until you
do. It may take a minute or two.

=== Using Let’s Encrypt certificates

NOTE: The target host must have port 80 exposed to the public internet.

[arabic]
. Use the https://certbot.eff.org/instructions[Electronic Frontier
Foundation’s documentation] to install the Let’s Encrypt certbot on your
target host. To locate the correct instructions, select *None of the
above* under *Software*.
. Request a certificate for a web server not currently running on the
machine: `sudo certbot certonly --standalone`.
. Provide a fully qualified domain name (FQDN) at the prompt. Let’s
Encrypt requires a domain name and will not issue a certificate to an IP
address.
+
TIP: If you don’t have a fully qualified domain name, add `xip.io` to
the end of your public IP address. For example, if your public IP was
`104.196.244.75`, you would use the address `104.196.244.75.xip.io`.
While this could be useful for a demo, we do not recommend `xip.io` or
`nip.io` addresses in production.
. The certbot should obtain four certificates and deposit these in a
local directory. Confirm that the files exist in the specified
directory. In the following example, we check an example directory
location for Ubuntu.
+
[source,console]
----
sudo ls /etc/letsencrypt/live/104.196.244.75.xip.io/
----
+
It should return a list of three certificates and one private key.
+
[source,console]
----
README  cert.pem  chain.pem  fullchain.pem  privkey.pem
----
+
TIP: Read more about the Let’s Encrypt certificates in the `README` and
the
https://certbot.eff.org/docs/using.html#where-are-my-certificates[certbot
documentation].
. For convenience, let’s briefly open a root shell session and navigate
into the directory to accomplish a few tasks.
+
[source,console]
----
sudo su
cd /etc/letsencrypt/live/104.196.244.75.xip.io/
----
. Concatenate the `cert.pem` and `chain.pem` files into one file named
`public-cert.pem`.
+
[source,console]
----
cat cert.pem chain.pem > public-cert.pem
----
. Copy the `chain.pem` file to a new file named `public-ca.pem`.
+
[source,console]
----
cp chain.pem public-ca.pem
----
. Copy the `privkey.pem` file to a new file named `public-key.pem`.
+
[source,console]
----
cp privkey.pem public-key.pem
----
. Exit the root shell session.
+
[source,console]
----
exit
----
+
Great job! Return to link:#about-segment-console-certificates[the top of
the page] to start the Segment Console container with valid
certificates.
+
WARNING: The certificate expires in 90 days. While certbot automatically
renews the certificate, you must repeat the concatenation and file copy
steps above, and then restart your container to apply the renewed
certificates.
