
// WE PULL THIS CONTENT FROM https://github.com/aporeto-inc/apoctl
// DO NOT EDIT THIS FILE.
// YOU MUST SUBMIT A PR AGAINST THE UPSTREAM REPO.
// THE UPSTREAM REPO IS CURRENTLY PRIVATE.

== `auth` command

The `auth` command is used to retrieve a Segment token.

....
eval $(apoctl auth aporeto --account mycompany -e)
Aporeto account password:
....

This stores your token in the environment variable `APOCTL_TOKEN`.

You can set the validity of the token by passing the global flag
`--validity`.

Example:

....
apoctl auth <subcommand> --validity 2h
....

You can set the maximum number of times the token can be used by passing
the global flag `--quota`.

Example:

....
apoctl auth <subcommand> --quota 4
....

If you like to issue a token that would end up having less permissions
than you initially have, you can use the following options:

* `--restrict-namespace`: The token will only be valid in the given
namespace and below, provided you initially have the permissions on that
namespace.
* `--restrict-role`: The token will only be valid for the give role or
raw permission, provided you initially have these permissions.
* `--restrict-network`: The token will only be valid if used from the
given networks, provided you initially have these permissions.

Example:

....
apoctl auth  <subcommand> \
  --restrict-namespace /namespace/child \
  --restrict-role '@auth:role=enforcer' \
  --restrict-role '@auth:role=enforcer.runtime' \
  --restrict-network 10.0.0.0/8 \
  --restrict-network 192.168.0.0/16
....

You can set opaque data by passing the flag `--opaque`. Opaque data will
be added in the `opaque` property of the issued token. They cannot be
used in authorization policies but they can be used by various clients
as trusted hints from an authenticated user.

Example:

....
apoctl auth <subcommand> --opaque key1:value1 --opaque key2:value2
....

=== `appcred` subcommand

The `appcred` subcommand allows you to retrieve a Segment token using an
app credential file.

Example:

....
apoctl auth appcred --path /path/to/creds.json
....

=== `cert` subcommand

The `cert` subcommand retrieves a Segment token using a X.509
certificate.

If you have a certificate and key PEM file, run:

....
apoctl auth cert --cert cert.pem --key key.pem
....

If you have a PKCS12 bundle, run:

....
apoctl auth cert --p12 cert.p12 --p12-pass passphrase
....

=== `pcc` subcommand

The `pcc` subcommand allows you to retrieve a Segment token using a
Prisma Cloud Compute (PCC) user and password.

For example:

....
apoctl auth pcc \
  --namespace /namespace \
  --provider p1 \
  --user username
....

=== `pcc-token` subcommand

The `pcc-token` subcommand allows you to retrieve a Segment token using
an already delivered Prisma Cloud Compute (PCC) identity token.

The provider must be first configured in your Segment namespace for this
authentication method to work.

You must also know the PCC provider name that has been configured if
there is no default one.

If you omit the flag `--token`, it will be prompted from the standard
input.

For example:

....
apoctl auth pcc-token \
  --namespace /namespace \
  --provider p1 \
  --token xxx.xxxxxx.xxx
....

=== `token` subcommand

The `token` subcommand allows you to retrieve a Segment token using an
already delivered Segment identity token.

The delivered token validity will be capped by the original expiration
time so that it is not possible to extend the lifetime of a token. The
claims of the new token will also be identical to the original ones.

This realm is useful when you have a token you want to use to restrict
the permissions in order to delegate some operation to a third party
user or system.

If you omit the flag `--token`, it will be prompted from the standard
input.

For example:

....
apoctl auth token \
  --token xxx.xxxxxx.xxx \
  --restrict-role @auth:role=enforcer
....

=== `verify` subcommand

The `verify` subcommand allows you to verify and print information about
a Segment token.

Example:

....
apoctl auth verify --token secret-token
{
  "aud": "{{< ctrl-plane-api-url >}}",
  "data": {
      "account": "myaccount",
      "email": "me@myaccount.com",
      "id": "5be902701d6cb60001e2881f",
      "organization": "myaccount",
      "realm": "vince"
  },
  "exp": 1540493393,
  "iat": 1540403393,
  "iss": "midgard.{{< ctrl-plane-api-url >}}",
  "realm": "Vince",
  "sub": "1234567890"
}
....

Note that if `$APOCTL_TOKEN` is set, you can just run:

....
apoctl auth verify
....

You can also set the flag `--token` to `-` in order to read the token
from standard input.

