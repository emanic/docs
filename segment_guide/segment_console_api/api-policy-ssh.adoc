== policy/ssh

=== SSHAuthorizationPolicy

An SSH authorization allows you to define the permissions for the owner
of a OpenSSH certificate issued by a Segment certificate authority. You
can define if a user with some claims can connect to an `sshd` server
managed by an instance of `enforcerd` according to its tags, what
permissions he has and for how long delivered certificates are valid.

==== Example

[source,json]
----
{
  "disabled": false,
  "fallback": false,
  "name": "the name",
  "propagate": false,
  "protected": false,
  "requireSystemAccountMatching": false,
  "validity": "1h"
}
----

==== Relations

===== `GET /sshauthorizationpolicies`

Retrieves the list of SSH authorizations.

Parameters:

* `q` (`string`): Filtering query. Consequent `q` parameters will form
an or.
* `propagated` (`boolean`): Also retrieve the objects that propagate
down.

===== `POST /sshauthorizationpolicies`

Creates a new SSH authorizations.

===== `DELETE /sshauthorizationpolicies/:id`

Deletes the SSH authorization with the given ID.

Parameters:

* `q` (`string`): Filtering query. Consequent `q` parameters will form
an or.

===== `GET /sshauthorizationpolicies/:id`

Retrieves the SSH authorization with the given ID.

Parameters:

* `propagated` (`boolean`): Also retrieve the objects that propagate
down.

===== `PUT /sshauthorizationpolicies/:id`

Updates the SSH authorization with the given ID.

==== Attributes

===== `ID` [`identifier`,`autogenerated`,`read_only`]

Type: `string`

Identifier of the object.

===== `activeDuration` [`format=^[0-9]+[smh]$`]

Type: `string`

Defines for how long the policy will be active according to the
`activeSchedule`.

===== `activeSchedule`

Type: `string`

Defines when the policy should be active using the cron notation. The
policy will be active for the given `activeDuration`.

===== `annotations`

Type: `map[string][]string`

Stores additional information about an entity.

===== `associatedTags`

Type: `[]string`

List of tags attached to an entity.

===== `authorizedSubnets`

Type: `[]string`

If set, the SSH authorization will only be valid if the request comes
from one the declared subnets.

===== `createTime` [`autogenerated`,`read_only`]

Type: `time`

Creation date of the object.

===== `description` [`max_length=1024`]

Type: `string`

Description of the object.

===== `disabled`

Type: `boolean`

Defines if the property is disabled.

===== `expirationTime`

Type: `time`

If set the SSH authorization will be automatically deleted after the
given time.

===== `extensions`

Type: `[]string`

The list of permissions to apply to the OpenSSH certificate. You can
check the list of standard extensions at
https://github.com/openssh/openssh-portable/blob/38e83e4f219c752ebb1560633b73f06f0392018b/PROTOCOL.certkeys#L281.

===== `fallback`

Type: `boolean`

Indicates that this is fallback policy. It will only be applied if no
other policies have been resolved. If the policy is also propagated it
will become a fallback for children namespaces.

===== `forceCommand`

Type: `string`

Specify a single command that the user can issue on the remote host.
This can be useful for issuing single-purpose certificates; ensuring
that users stay in their home directories (`internal-sftp`); and
restricting users to a bash shell (`/bin/bash`), preventing them from
running arbitrary and unlogged commands such as `scp`, `rsync`, `-essh`,
and `sftp`. Refer to the
https://www.freebsd.org/cgi/man.cgi?sshd_config(5)[FreeBSD
documentation] for more information.

===== `metadata` [`creation_only`]

Type: `[]string`

Contains tags that can only be set during creation, must all start with
the `@' prefix, and should only be used by external systems.

===== `name` [`required`,`max_length=256`]

Type: `string`

Name of the entity.

===== `namespace` [`autogenerated`,`read_only`]

Type: `string`

Namespace tag attached to an entity.

===== `normalizedTags` [`autogenerated`,`read_only`]

Type: `[]string`

Contains the list of normalized tags of the entities.

===== `object`

Type: `[][]string`

Contains the tag expression identifying the defenders on the hosts the
`subject` is allowed to access.

===== `principals`

Type: `[]string`

On systems without the Segment defender, you must provide the name of
the Linux user. Otherwise, Segment will automatically populate this
field and adding a value here is optional and not used during the
authorization. However, the value becomes a tag associated with the SSH
processing unit, which could be useful.

===== `propagate`

Type: `boolean`

Propagates the policy to all of its children.

===== `protected`

Type: `boolean`

Defines if the object is protected.

===== `requireSystemAccountMatching`

Type: `boolean`

If selected, the system account will be used to log into the resource.

===== `subject`

Type: `[][]string`

Contains the tag expression that identifies the user or group of users
that should be allowed to access the remote hosts. If the user
authenticates against an OIDC provider, these tags correspond to claims
in the ID token.

===== `updateTime` [`autogenerated`,`read_only`]

Type: `time`

Last update date of the object.

===== `validity`

Type: `string`

Set the validity of the delivered SSH certificate.

Default value:

[source,json]
----
"1h"
----

=== SSHIdentity

Returns an SSH certificate containing the bearer claims. This SSH
certificate can be used to connect to a node where the defender is
protecting SSH sessions.

==== Example

[source,json]
----
{
  "publicKey": "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCytT my key"
}
----

==== Relations

===== `POST /sshidentities`

Creates a new SSH certificate.

==== Attributes

===== `certificate` [`autogenerated`,`read_only`]

Type: `string`

Contains the signed SSH certificate in OpenSSH format.

===== `publicKey` [`required`]

Type: `string`

Contains the public key to sign in OpenSSH format. You can generate an
SSH public key with the standard `ssh-keygen` tool.

===== `systemAccount`

Type: `string`

Define the targeted system account name.
