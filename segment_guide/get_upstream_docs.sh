#!/bin/bash
# Must set GITHUB_TOKEN and have access to private apoctl repo in aporeto-inc org
# Requires GNU sed, expects to use gsed
# Requires GNU csplit, expects to call it as gcsplit

export BRANCH=master


echo "Getting API overview"
curl --silent -o api-overview.md "https://raw.githubusercontent.com/aporeto-inc/gaia/${BRANCH}/doc/README.md"

pandoc api-overview.md -o api-overview.adoc

cat << EOF > about.adoc

// WE PULL THIS CONTENT FROM https://github.com/aporeto-inc/gaia
// DO NOT EDIT THIS FILE.
// YOU MUST SUBMIT A PR AGAINST THE UPSTREAM REPO.

== About the Segment Console API

$(sed -e '1,2d' < api-overview.adoc)
EOF

rm -f api-overview.md
rm -f api-overview.adoc
rm -f segment_console_api/about.adoc
mv about.adoc segment_console_api/about.adoc


echo "Getting API reference"
curl --silent -o api-ref.md "https://raw.githubusercontent.com/aporeto-inc/gaia/${BRANCH}/doc/documentation.md"
echo "Splitting file"
gcsplit --prefix='api-ref' --suffix-format='%03d.md' api-ref.md '/^##\s/' "{*}"

rm api-ref000.md
echo "Saving core"
pandoc api-ref001.md -o api-core.adoc
mv api-core.adoc segment_console_api/api-core.adoc
rm api-ref001.md
echo "Saving core/account"
pandoc api-ref002.md -o api-core-account.adoc
mv api-core-account.adoc segment_console_api/api-core-account.adoc
rm api-ref002.md
echo "Saving core/authentication"
pandoc api-ref003.md -o api-core-authentication.adoc
mv api-core-authentication.adoc segment_console_api/api-core-authentication.adoc
rm api-ref003.md
echo "Saving core/billing"
pandoc api-ref004.md -o api-core-billing.adoc
mv api-core-billing.adoc segment_console_api/api-core-billing.adoc
rm api-ref004.md
echo "Saving core/enforcer"
pandoc api-ref005.md -o api-core-enforcer.adoc
mv api-core-enforcer.adoc segment_console_api/api-core-enforcer.adoc
rm api-ref005.md
echo "Saving core/monitoring"
pandoc api-ref006.md -o api-core-monitoring.adoc
mv api-core-monitoring.adoc segment_console_api/api-core-monitoring.adoc
rm api-ref006.md
echo "Saving core/namespace"
pandoc api-ref007.md -o api-core-namespace.adoc
mv api-core-namespace.adoc segment_console_api/api-core-namespace.adoc
rm api-ref007.md
echo "Saving core/policy"
pandoc api-ref008.md -o api-core-policy.adoc
mv api-core-policy.adoc segment_console_api/api-core-policy.adoc
rm api-ref008.md
echo "Saving core/processingunit"
pandoc api-ref009.md -o api-core-processingunit.adoc
mv api-core-processingunit.adoc segment_console_api/api-core-processingunit.adoc
rm api-ref009.md
echo "Saving core/tag"
pandoc api-ref010.md -o api-core-tag.adoc
mv api-core-tag.adoc segment_console_api/api-core-tag.adoc
rm api-ref010.md
echo "Saving core/workflow"
pandoc api-ref011.md -o api-core-workflow.adoc
mv api-core-workflow.adoc segment_console_api/api-core-workflow.adoc
rm api-ref011.md
echo "Saving debug"
pandoc api-ref012.md -o api-debug.adoc
mv api-debug.adoc segment_console_api/api-debug.adoc
rm api-ref012.md
echo "Saving ext/documentation"
pandoc api-ref013.md -o api-ext-documentation.adoc
mv api-ext-documentation.adoc segment_console_api/api-ext-documentation.adoc
rm api-ref013.md
echo "Saving integration/apiproxy"
pandoc api-ref014.md -o api-integration-apiproxy.adoc
mv api-integration-apiproxy.adoc segment_console_api/api-integration-apiproxy.adoc
rm api-ref014.md
echo "Saving integration/app"
pandoc api-ref015.md -o api-integration-app.adoc
mv api-integration-app.adoc segment_console_api/api-integration-app.adoc
rm api-ref015.md
echo "Saving integration/automation"
pandoc api-ref016.md -o api-integration-automation.adoc
mv api-integration-automation.adoc segment_console_api/api-integration-automation.adoc
rm api-ref016.md

echo "Getting apoctl usage"
curl --silent -o apoctl-ref.md -H "Authorization: token ${GITHUB_TOKEN}" "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/apoctl.md"

pandoc apoctl-ref.md -o apoctl-ref.adoc

cat << EOF > usage.adoc

// WE PULL THIS CONTENT FROM https://github.com/aporeto-inc/apoctl
// DO NOT EDIT THIS FILE.
// YOU MUST SUBMIT A PR AGAINST THE UPSTREAM REPO.
// THE UPSTREAM REPO IS CURRENTLY PRIVATE.

== Usage

$(sed -e '1,2d' < apoctl-ref.adoc)
EOF

rm -f apoctl-ref.md
rm -f apoctl-ref.adoc
rm -f apoctl/usage.adoc
mv usage.adoc apoctl/usage.adoc

echo "Getting apoctl api command"

curl --silent -o apoctl-api.md -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/api.md"

echo >> apoctl-api.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/api-all.md" >> apoctl-api.md

echo >> apoctl-api.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/api-count.md" >> apoctl-api.md

echo >> apoctl-api.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/api-create.md" >> apoctl-api.md

echo >> apoctl-api.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/api-delete.md" >> apoctl-api.md

echo >> apoctl-api.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/api-delete-many.md" >> apoctl-api.md

echo >> apoctl-api.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/api-describe.md" >> apoctl-api.md

echo >> apoctl-api.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/api-export.md" >> apoctl-api.md

echo >> apoctl-api.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/api-get.md" >> apoctl-api.md

echo >> apoctl-api.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/api-import.md" >> apoctl-api.md

echo >> apoctl-api.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/api-info.md" >> apoctl-api.md

echo >> apoctl-api.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/api-list.md" >> apoctl-api.md

echo >> apoctl-api.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/api-listen.md" >> apoctl-api.md

echo >> apoctl-api.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/api-search.md" >> apoctl-api.md

echo >> apoctl-api.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/api-stub.md" >> apoctl-api.md

echo >> apoctl-api.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/api-update.md" >> apoctl-api.md

echo >> apoctl-api.md

pandoc apoctl-api.md -o apoctl-api.adoc

cat << EOF > api.adoc

// WE PULL THIS CONTENT FROM https://github.com/aporeto-inc/apoctl
// DO NOT EDIT THIS FILE.
// YOU MUST SUBMIT A PR AGAINST THE UPSTREAM REPO.
// THE UPSTREAM REPO IS CURRENTLY PRIVATE.

$(< apoctl-api.adoc)

EOF

rm -f apoctl-api.md
rm -f apoctl-api.adoc
rm -f apoctl/api.adoc
mv api.adoc apoctl/api.adoc

echo "Getting apoctl appcred command"

curl --silent -o apoctl-appcred.md -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/appcred.md"

echo >> apoctl-appcred.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/appcred-create.md" >> apoctl-appcred.md

echo >> apoctl-appcred.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/appcred-delete.md" >> apoctl-appcred.md

echo >> apoctl-appcred.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/appcred-disable.md" >> apoctl-appcred.md

echo >> apoctl-appcred.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/appcred-enable.md" >> apoctl-appcred.md

echo >> apoctl-appcred.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/appcred-list.md" >> apoctl-appcred.md

echo >> apoctl-appcred.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/appcred-renew.md" >> apoctl-appcred.md

echo >> apoctl-appcred.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/appcred-roles.md" >> apoctl-appcred.md

echo >> apoctl-appcred.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/appcred-subnets.md" >> apoctl-appcred.md

echo >> apoctl-appcred.md

pandoc apoctl-appcred.md -o apoctl-appcred.adoc

cat << EOF > appcred.adoc

// WE PULL THIS CONTENT FROM https://github.com/aporeto-inc/apoctl
// DO NOT EDIT THIS FILE.
// YOU MUST SUBMIT A PR AGAINST THE UPSTREAM REPO.
// THE UPSTREAM REPO IS CURRENTLY PRIVATE.

$(< apoctl-appcred.adoc)

EOF

rm -f apoctl-appcred.md
rm -f apoctl-appcred.adoc
rm -f apoctl/appcred.adoc
mv appcred.adoc apoctl/appcred.adoc

echo "Getting apoctl auth command"

curl --silent -o apoctl-auth.md -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/auth.md"

echo >> apoctl-auth.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/auth-aporeto.md" >> apoctl-auth.md

echo >> apoctl-auth.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/auth-appcred.md" >> apoctl-auth.md

echo >> apoctl-auth.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/auth-awssts.md" >> apoctl-auth.md

echo >> apoctl-auth.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/auth-azure.md" >> apoctl-auth.md

echo >> apoctl-auth.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/auth-cert.md" >> apoctl-auth.md

echo >> apoctl-auth.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/auth-gcp.md" >> apoctl-auth.md

echo >> apoctl-auth.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/auth-google.md" >> apoctl-auth.md

echo >> apoctl-auth.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/auth-ldap.md" >> apoctl-auth.md

echo >> apoctl-auth.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/auth-oidc.md" >> apoctl-auth.md

echo >> apoctl-auth.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/auth-pcc.md" >> apoctl-auth.md

echo >> apoctl-auth.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/auth-pcc-token.md" >> apoctl-auth.md

echo >> apoctl-auth.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/auth-saml.md" >> apoctl-auth.md

echo >> apoctl-auth.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/auth-token.md" >> apoctl-auth.md

echo >> apoctl-auth.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/auth-verify.md" >> apoctl-auth.md

echo >> apoctl-auth.md

pandoc apoctl-auth.md -o apoctl-auth.adoc

cat << EOF > auth.adoc

// WE PULL THIS CONTENT FROM https://github.com/aporeto-inc/apoctl
// DO NOT EDIT THIS FILE.
// YOU MUST SUBMIT A PR AGAINST THE UPSTREAM REPO.
// THE UPSTREAM REPO IS CURRENTLY PRIVATE.

$(< apoctl-auth.adoc)

EOF

rm -f apoctl-auth.md
rm -f apoctl-auth.adoc
rm -f apoctl-auth.adoc
mv auth.adoc apoctl/auth.adoc

echo "Getting apoctl stats command"

curl --silent -o apoctl-stats.md -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/stats.md"

echo >> apoctl-stats.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/stats-info.md" >> apoctl-stats.md

echo >> apoctl-stats.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/stats-query.md" >> apoctl-stats.md

echo >> apoctl-stats.md

pandoc apoctl-stats.md -o apoctl-stats.adoc

cat << EOF > stats.adoc

// WE PULL THIS CONTENT FROM https://github.com/aporeto-inc/apoctl
// DO NOT EDIT THIS FILE.
// YOU MUST SUBMIT A PR AGAINST THE UPSTREAM REPO.
// THE UPSTREAM REPO IS CURRENTLY PRIVATE.

$(< apoctl-stats.adoc)

EOF

rm -f apoctl-stats.md
rm -f apoctl-stats.adoc
rm -f apoctl-stats.adoc
mv stats.adoc apoctl/stats.adoc

echo "Getting apoctl reports command"

curl --silent -o apoctl-reports.md -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/reports.md"

echo >> apoctl-reports.md

curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
  "https://raw.githubusercontent.com/aporeto-inc/apoctl/${BRANCH}/docs/compliance.md" >> apoctl-reports.md

echo >> apoctl-reports.md

pandoc apoctl-reports.md -o apoctl-reports.adoc

cat << EOF > reports.adoc

// WE PULL THIS CONTENT FROM https://github.com/aporeto-inc/apoctl
// DO NOT EDIT THIS FILE.
// YOU MUST SUBMIT A PR AGAINST THE UPSTREAM REPO.
// THE UPSTREAM REPO IS CURRENTLY PRIVATE.

$(< apoctl-reports.adoc)

EOF

rm -f apoctl-reports.md
rm -f apoctl-reports.adoc
rm -f apoctl-reports.adoc
mv reports.adoc apoctl/reports.adoc
