// WE PULL THIS CONTENT FROM https://github.com/aporeto-inc/junon
// DO NOT EDIT THIS FILE.
// YOU MUST SUBMIT A PR AGAINST THE UPSTREAM REPO.
// THE UPSTREAM REPO IS CURRENTLY PRIVATE.

== Install Segment Console

=== About installing Segment Console

To get started, we provide a single image containing the entire Segment
Console. You can launch it with either:

* *link:#launching-segment-console-with-kubernetes[Kubernetes]*:
(*_supported for production_*) if you have a Kubernetes cluster, we
recommend using our Helm chart to deploy the Segment Console container
as a
https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/[`StatefulSet`].
This option provides better availability and more features, such as app
integrations.
* *link:#launching-segment-console-with-docker[Docker]*: (*_not
supported for production_*) relies on your container runtime to keep
Segment Console up. Suitable for demos or proof-of-concepts.

TIP: You can migrate to a multi-container Segment Console later if you
wish.

=== Launching Segment Console with Kubernetes

==== Requirements

* https://docs.twistlock.com/docs/compute_edition/install/install.html[Prisma
Cloud Compute Console installed]
* https://helm.sh/docs/intro/install/[Helm client]
* Kubernetes 1.14 or later cluster
* Two or more Linux nodes in the cluster with at least 8vCPU and 16GB
memory

==== Launching Segment Console

[arabic]
. Add the Segment Helm repository.
+
[source,console]
----
helm repo add aporeto http://helm.aporeto.us/master/stable/svcs
----
. Create a namespace for Segment Console.
+
[source,console]
----
kubectl create namespace segment
----
. Deploy Segment Console.
+
[source,console]
----
helm install console aporeto/console \
        --set networking.serviceType=LoadBalancer \
        --set storage.class=standard \
        --set imageRegistry=gcr.io/aporetodev \
        --set imagePullSecret=gcr-docker \
        -n segment
----
. Use the following command to save the public IP of Segment Console to
an environment variable named `CONSOLE_LB`.
+
[source,console]
----
CONSOLE_LB=$(kubectl -n segment get service console -o jsonpath="{.status.loadBalancer.ingress[0]['address','ip','hostname']}")
echo $CONSOLE_LB
----
. Update Segment Console to use the external IP address.
+
[source,console]
----
helm upgrade \
       -n segment \
       console \
       aporeto/console \
       --reuse-values \
       --set console.url=https://$CONSOLE_LB \
       --description "Updating console endpoints"
----
. Open the Prisma Cloud Compute Console web interface and click
*Segment* in the left navigation menu.
. Toggle *Enable micro-segmentation* to *On*.
. Return to your terminal and issue the following command to bind the
Segment and Prisma Cloud Compute Consoles, where
`<pcc-console-ui-url:port>` contains the IP or FQDN and port of the
Prisma Cloud Compute Console and `<organization-name>` contains the name
of your organization.
* *Syntax*
+
[source,console]
----
kubectl -n segment exec console-0 -- pcc-binding <pcc-console-ui-url:port> <organization-name>
----
* *Example*
+
[source,console]
----
kubectl -n segment exec console-0 -- pcc-binding https://54.190.67.151:8083 acme
----
+
IMPORTANT: The address of the Prisma Cloud Computer Console must be
reachable from your Segment Console host. If in doubt, conduct a quick
`ping` from the Segment Console host.
. The `pcc-binding` script should return two values:
* Segment Console web interface URL
* Segment Console app credential
. Copy these values and paste them into the Prisma Cloud Compute
Console, then click *Save*.
. Click *Launch Segment Console*.

TIP: To learn about advanced networking, storage, backup, and custom
certificate options, issue the following command
`helm inspect readme aporeto/console`

=== Launching Segment Console with Docker

==== Requirements

* https://docs.twistlock.com/docs/compute_edition/install/install.html[Prisma
Cloud Compute Console installed]
* Target host
** Linux
** https://docs.docker.com/get-docker/[Docker 18.02 or later]
** IP address or domain name reachable by users and tthe Prisma Cloud
Compute Console
** Two ports exposed (for maximum ease of use, we recommend ports `443`
and `1443`)
** At least 8vCPU
** At least 16GB memory

==== Launching Segment Console

[arabic]
. Set an environment variable containing the routable IP address or
domain of the Segment Console host. Examples follow.
* *FQDN*
+
[source,console]
----
export ADDRESS=https://segment.acme.com
echo $ADDRESS
----
* *IP address*
+
[source,console]
----
export ADDRESS=https://104.196.244.75
echo $ADDRESS
----
. Create a local directory to store the Segment Console data and logs.
The following location should work on most Linux distributions.
+
[source,console]
----
sudo mkdir ~/aporeto
ls
----
. Use the following command to launch the Segment Console container.
+
[source,console]
----
sudo docker run -d --name=segment-console \
        --restart always \
        -e APORETO_CONSOLE_URL=$ADDRESS \
        -p 443:1443 -p 4443:4443 \
        -v /home/$USER/aporeto:/aporeto-data \
        gcr.io/aporetodev/console:master-staging
----
+
NOTE: This command assumes that you created the directory that we
suggested and have opened ports `443` and `1443`. Otherwise, you must
modify the command as needed.
. Check the logs.
+
[source,console]
----
sudo docker logs console
----
+
It should return something like the following.
+
[source,console]
----
Backend  v1.1378.0 (1befe075fca0d7641061b16a9a5d8869da179bb7) master Frontend v1.1141.0 (45bc8cd5261391f486a098ef4393cc15c171ca7d)
Loading  configuration  1s
Starting databases      3s
[WARNING] No volume mounted on /backup. Backups are disabled.
Starting services       22s
[READY] Aporeto is now up and accessible through https://segment.acme.com
----
+
TIP: If you donâ€™t see the `READY` message, rerun the command until you
do. It may take a minute or two.
. Open the Prisma Cloud Compute Console web interface and click
*Segment* in the left navigation menu.
. Toggle *Enable micro-segmentation* to *On*.
. Return to your terminal and issue the following command to bind the
Segment and Prisma Cloud Compute Consoles, where
`<pcc-console-ui-url:port>` contains the IP or FQDN and port of the
Prisma Cloud Compute Console and `<organization-name>` contains the name
of your organization.
* *Syntax*
+
[source,console]
----
docker exec -it segment-console pcc-binding <pcc-console-ui-url:port> <organization-name>
----
* *Example*
+
[source,console]
----
docker exec -it segment-console pcc-binding https://54.190.67.151:8083 acme
----
+
IMPORTANT: The address of the Prisma Cloud Computer Console must be
reachable from your Segment Console host. If in doubt, conduct a quick
`ping` from the Segment Console host.
. The `pcc-binding` script should return two values:
* Segment Console web interface URL
* Segment Console app credential
. Copy these values and paste them into the Prisma Cloud Compute
Console, then click *Save*.
. Click *Launch Segment Console*.

TIP: Explore additional customization options by running the following
command: `docker run --rm -ti aporeto/console:master-staging -h`
