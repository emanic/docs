// WE PULL THIS CONTENT FROM https://github.com/aporeto-inc/junon
// DO NOT EDIT THIS FILE.
// YOU MUST SUBMIT A PR AGAINST THE UPSTREAM REPO.
// THE UPSTREAM REPO IS CURRENTLY PRIVATE.

== Install Segment Console

=== About installing Segment Console

To get started, we provide a single image containing the entire Segment
Console. You can launch it with either:

* *link:#launching-segment-console-with-kubernetes[Kubernetes]*:
(*_supported for production_*) if you have a Kubernetes cluster, we
recommend using our Helm chart to deploy the Segment Console container
as a
https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/[`StatefulSet`].
This option provides better availability and more features, such as app
integrations.
* *link:#launching-segment-console-with-docker[Docker]*: (*_not
supported for production_*) relies on your container runtime to keep
Segment Console up. Suitable for demos or proof-of-concepts.

TIP: You can migrate to a multi-container Segment Console later if you
wish.

=== Launching Segment Console with Kubernetes

==== Requirements

* https://docs.paloaltonetworks.com/prisma/prisma-cloud/20-08/prisma-cloud-compute-edition-admin/install/getting_started.html[Prisma
Cloud Compute (PCC) Console installed] (any method except Onebox)
+
NOTE: Do not install PCC using the Onebox method. Enabling Segment
requires the Defenders to be redeployed. If you use the Onebox method,
you won’t be able to redeploy the Defender.
* https://helm.sh/docs/intro/install/[Helm client]
* Kubernetes 1.14 or later cluster
* Two or more Linux nodes in the cluster with at least 8vCPU and 16GB
memory
+
IMPORTANT: By default, the `kubectl` installed by GKE does not have the
`container.clusterRoleBindings.create` permission, which is required.
Refer to the
https://cloud.google.com/kubernetes-engine/docs/how-to/role-based-access-control[Google
documentation] for more information. One way around this is to create a
cluster using the `--enable-basic-auth` flag. Run
`gcloud container clusters describe <cluster-name>` and look for the
`password` value. Run
`kubectl config set-credentials cluster-admin --user=admin --password=<password-value>`
to set the password in your configuration file. Then run
`kubectl config set-context --current --user=cluster-admin` to configure
your current context to use this user account.

==== Launching Segment Console

[arabic]
. Add the Segment Helm repository.
+
[source,console]
----
helm repo add aporeto http://helm.aporeto.us/releases/release-4.0.1-rc3/svcs
----
. Create a namespace for Segment Console.
+
[source,console]
----
kubectl create namespace segment
----
. Deploy Segment Console.
+
[source,console]
----
helm install console aporeto/console \
        --set networking.serviceType=LoadBalancer \
        --set storage.class=standard \
        --set imageRegistry=gcr.io/aporetodev \
        --set imagePullSecret=gcr-docker \
        -n segment
----
. It can take a minute or two for Kubernetes to assign an external IP.
Use the following command to monitor the progress.
+
[source,console]
----
watch kubectl get services --namespace segment
----
. Once an external IP address is shown, press CTRL+C to exit the `watch`
command.
. Use the following command to save the public IP of Segment Console to
an environment variable named `CONSOLE`.
+
[source,console]
----
CONSOLE=https://$(kubectl -n segment get service console -o jsonpath="{.status.loadBalancer.ingress[0]['address','ip','hostname']}")
----
. Update Segment Console to use the external IP address.
+
[source,console]
----
helm upgrade \
       -n segment \
       console \
       aporeto/console \
       --reuse-values \
       --set console.url=$CONSOLE \
       --description "Updating console endpoints"
----
. Open the Segment Console web interface by pasting the external IP into
your browser.
+
[source,console]
----
echo $CONSOLE
----
. Click through the warnings to accept the certificate.
. Open the PCC Console web interface and click *Segment* in the left
navigation menu.
. Toggle *Enable Segment* to *On*.
. Under *Choose Prisma Cloud Compute Console address*, select an address
and port of the PCC Console that Segment Console can reach. If you’re
not sure, select the FQDN or public IP address of PCC Console.
+
TIP: Ensure that Segment Console can reach your selection by performing
a `ping` from the Segment Console host.
. Type the name of your organization. Example: `acme`.
. Click *Copy* beside *Kubernetes* to get the `kubectl` command.
. Return to your terminal, paste the command, and press ENTER.
. The `pcc-binding` script should return two values:
* Segment Console web interface URL
* Segment Console app credential
. Copy these values and paste them into the PCC Console, then click
*Save*.
. Click *Launch Segment Console*.
. Inside the Segment Console web interface, click *Platform*.
. In the top right corner, toggle *Discover mode* to on.
. Click *Next*, toggle *Propagate to child namesapces* to on, click
*Next*, then click *Apply*.

TIP: To learn about advanced networking, storage, backup, and custom
certificate options, issue the following command
`helm inspect readme aporeto/console`

=== Launching Segment Console with Docker

==== Requirements

* https://docs.twistlock.com/docs/compute_edition/install/install.html[Prisma
Cloud Compute Console installed]
* Target host
** Linux
** https://docs.docker.com/get-docker/[Docker 18.02 or later]
** IP address or domain name reachable by users and the Prisma Cloud
Compute Console
** Two ports exposed (for maximum ease of use, we recommend ports `443`
and `1443`)
** At least 8vCPU
** At least 16GB memory

==== Launching Segment Console

[arabic]
. Set an environment variable called `CONSOLE` containing the routable
IP address or domain of the Segment Console host. Examples follow.
* *FQDN*
+
[source,console]
----
export CONSOLE=https://segment.acme.com
echo $CONSOLE
----
* *IP address*
+
[source,console]
----
export CONSOLE=https://104.196.244.75
echo $CONSOLE
----
. Create a local directory to store the Segment Console data and logs.
The following location should work on most Linux distributions.
+
[source,console]
----
sudo mkdir ~/aporeto
ls
----
. Use the following command to launch the Segment Console container.
+
[source,console]
----
sudo docker run -d --name=segment-console \
        --restart always \
        -e APORETO_CONSOLE_URL=$CONSOLE \
        -p 443:1443 -p 4443:4443 \
        -v /home/$USER/aporeto:/aporeto-data \
        gcr.io/aporetodev/console:master-staged
----
+
NOTE: This command assumes that you created the directory that we
suggested and have opened ports `443` and `1443`. Otherwise, you must
modify the command as needed.
. Check the logs.
+
[source,console]
----
sudo docker logs console
----
+
It should return something like the following.
+
[source,console]
----
Backend  v1.1378.0 (1befe075fca0d7641061b16a9a5d8869da179bb7) master Frontend v1.1141.0 (45bc8cd5261391f486a098ef4393cc15c171ca7d)
Loading  configuration  1s
Starting databases      3s
[WARNING] No volume mounted on /backup. Backups are disabled.
Starting services       22s
[READY] Aporeto is now up and accessible through https://segment.acme.com
----
+
TIP: If you don’t see the `READY` message, rerun the command until you
do. It may take a minute or two.
. Open the Prisma Cloud Compute Console web interface and click
*Segment* in the left navigation menu.
. Toggle *Enable Segment* to *On*.
. Under *Choose Prisma Cloud Compute Console address*, select an address
and port of the PCC Console that Segment Console can reach. If you’re
not sure, select the FQDN or public IP address of PCC Console.
+
TIP: Ensure that Segment Console can reach your selection by performing
a `ping` from the Segment Console host.
. Type the name of your organization. Example: `acme`.
. Click *Copy* beside *Docker* to get the `docker` command.
. Return to your terminal, paste the command, and press ENTER.
. The `pcc-binding` script should return two values:
* Segment Console web interface URL
* Segment Console app credential
. Copy these values and paste them into the PCC Console, then click
*Save*.
. Click *Launch Segment Console*.
. Click *Platform*.
. In the top right corner, toggle *Discover mode* to on.
. Click *Next*, toggle *Propagate to child namesapces* to on, click
*Next*, then click *Apply*.

TIP: Explore additional customization options by running the following
command: `docker run --rm -ti aporeto/console:master-staged -h`
