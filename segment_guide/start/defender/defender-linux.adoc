// WE PULL THIS CONTENT FROM https://github.com/aporeto-inc/junon
// DO NOT EDIT THIS FILE.
// YOU MUST SUBMIT A PR AGAINST THE UPSTREAM REPO.
// THE UPSTREAM REPO IS CURRENTLY PRIVATE.

== Linux host

=== About installing Defenders on Linux hosts

Before you begin, ensure that you meet the link:../reqs[system
requirements].

To install the Defender on a Linux host, you must retrieve and execute
our shell script from the target host. We provide three options.

* link:#quick-deployment[Quick deployment]: use the web interface to
obtain the command, then execute it from the target host. Prisma Cloud
Compute (PCC) Console creates and passes an app credential to the
Defender. The Defender uses the app credential to communicate with the
Segment Console API.
* link:#advanced-cloud-deployment[Advanced cloud deployment]:
recommended for production AWS, GCP, and Azure hosts. The Defender uses
short-lived tokens from the cloud provider to authenticate to Segment
Console. We provide a command-line based procedure to facilitate
automation.
* link:#advanced-on-premise-deployment[Advanced on-premise deployment]:
an advanced method of deploying the Defender to on-premise production
hosts. You create a restricted token for the Segment Defender. It
exchanges the token for an app credential. We provide a command-line
based procedure to facilitate automation.

=== Quick deployment

[arabic]
. From the PCC Console web interface, expand *Manage*, select
*Defenders*, select *Deploy*, and select *Single Defender*.
. In the first drop-down, select an address of Segment Console that the
target host can access.
. Select one of the following as the *Defender type*:
* *Host Defender - Linux*: deploys the Defender as a Linux service and
creates a processing unit that represents the host, allowing you to
control and monitor all host communications
* *Container Defender - Linux*: deploys the Defender as a container and
creates processing units for all containers on the host, allowing you to
control and monitor all container communications
. Leave the *Listener type* set to *None*.
+
IMPORTANT: Segment does not support the
https://docs.paloaltonetworks.com/prisma/prisma-cloud/20-08/prisma-cloud-compute-edition-admin/access_control/rbac.html[TCP
listener type]. Selecting *TCP* can cause the Defender to block
connections in an unpredictable manner.
. Ensure that *Segment* is toggled *On*.
. Under *registration type*, select *App credentials*.
. In the *namespace* field, type the namespace that you want to deploy
the Defender to. This should be a great grandchild namespace. Example:
`/acme/team-a/dev/vm1`
+
IMPORTANT: Ensure that you type the namespace correctly and that you
have permissions to deploy the Defender there. The PCC Console performs
no validation on your entries.
. You should be able to leave *Advanced flags* blank. Refer to
link:#advanced-flags[Advanced flags] if you’re interested in learning
about these options.
. Access the target host, such as via SSH.
. Copy the script from the web interface and execute it from a terminal
on the target host.
. Check the status of the Defender.
* *Service*
+
[source,console]
----
sudo systemctl status twistlock-defender-server.service
----
* *Container*
+
[source,console]
----
sudo docker ps
----
. In the PCC Console web interface, expand *Manage*, select *Defenders*,
and select *Manage*.
. You should see the Defender you just deployed with a status of
*Connected*.
. In the Segment Console web interface, expand *Manage* and select
*Defenders*.
. Either navigate to the namespace of the Defender or toggle *Recursive*
to on.
. The Defender you just deployed should be listed with a status of
*Connected*.

=== Advanced cloud deployment

NOTE: You can use either
https://docs.paloaltonetworks.com/prisma/prisma-cloud/20-08/prisma-cloud-compute-edition-admin/api/access_api.html[basic
authentication or client certificates] to authenticate to the Prisma
Cloud Compute (PCC) Console API. In this procedure, we use basic
authentication.

[arabic]
. Ensure that the target host has one of the following.
* *AWS*:
https://aws.amazon.com/blogs/security/easily-replace-or-attach-an-iam-role-to-an-existing-ec2-instance-by-using-the-ec2-console/[an
IAM role attached] with read-only access to tags
(https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-policy-structure.html[`ec2:DescribeTags`])
* *GCP*:
https://cloud.google.com/compute/docs/access/create-enable-service-accounts-for-instances[GCP
service account attached]
* *Azure*:
https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/qs-configure-portal-windows-vmss[assigned
a managed identity]
. Construct a link:../../../concepts/#tags-and-identity[Segment tag]
containing the cloud metadata that identifies Defenders authorized to
register with Segment. The tag must begin with `@auth:` followed by a
key-value pair. Refer to the table below for some common examples.
+
[width="99%",cols="<12%,<25%,<25%,<38%",options="header",]
|===
|Cloud provider |Value |Segment tag syntax |Segment tag example
|AWS |AWS account ID* |`@auth:account=<AWS_ACCOUNT_ID>`
|`@auth:account=942613894219`

|GCP |GCP project ID |`@auth:projectid=<GCP_PROJECT_ID>`
|`@auth:projectid=acme-dev`

|Azure |Microsoft tenant ID† |`@auth:tenantid=<TENANT_ID>`
|`@auth:tenantid=cd629cb5-2826-4126-82fd-3f2df5f5bc7`

|GCP and Azure |Name of organization
|`@auth:organization=<ORGANIZATION>` |`@auth:organization=acme`
|===
+
pass:[*] _You can find your AWS account ID under_ *My security credentials* _in
the AWS Management Console._
+
† _To learn how to find your tenant ID, refer to the_
https://techcommunity.microsoft.com/t5/Office-365/How-do-you-find-the-tenant-ID/td-p/89018[Microsoft
documentation].
. On your local host equipped with `apoctl`, set an `ID_TAG` environment
variable. If the target host is on AWS, also set a `ROLE_TAG`
environment variable.
* `ID_TAG` containing the Segment tag you’ve constructed to identify
authorized Defenders
* `ROLE_TAG` (AWS only) containing the name of the IAM role attached to
the instance prepended with `@auth:rolename=`
+
Examples follow.
* *AWS*:
+
[source,console]
----
export ID_TAG="@auth:account=942613894219"
export ROLE_TAG="@auth:rolename=segment"
----
* *GCP*:
+
[source,console]
----
export ID_TAG="@auth:projectid=acme-dev"
----
* *Azure*:
+
[source,console]
----
export ID_TAG="@auth:tenantid=cd629cb5-2826-4126-82fd-3f2df5f5bc7"
----
. Set a `TARGET_NS` environment variable containing the Segment
namespace for this Defender. This should be a great grandchild
namespace. An example follows.
+
[source,console]
----
export TARGET_NS=/acme/team-a/dev/vm1
----
. Create an API authorization that allows the Defender to access the
Segment Console. Use the command that corresponds to the cloud provider
of the target host.
* *AWS*
+
[source,console]
----
cat << EOF | apoctl api import -f -
APIVersion: 0
label: ec2-defender-auth
data:
      apiauthorizationpolicies:
        - authorizedIdentities:
            - '@auth:role=enforcer'
          authorizedNamespace: $TARGET_NS
          authorizedSubnets: []
          name: Authorize EC2 Defender to access Segment Console
          propagate: true
          subject:
            - - '@auth:realm=awssecuritytoken'
              - "$ID_TAG"
              - "$ROLE_TAG"
EOF
----
* *GCP*
+
[source,console]
----
cat << EOF | apoctl api import -f -
APIVersion: 0
label: gcp-defender-auth
data:
      apiauthorizationpolicies:
        - authorizedIdentities:
            - '@auth:role=enforcer'
          authorizedNamespace: $TARGET_NS
          authorizedSubnets: []
          name: Authorize GCP Defender to access Segment Console
          propagate: true
          subject:
            - - '@auth:realm=gcpidentitytoken'
              - "$ID_TAG"
EOF
----
* *Azure*
+
[source,console]
----
cat << EOF | apoctl api import -f -
APIVersion: 0
label: azure-defender-auth
data:
      apiauthorizationpolicies:
        - authorizedIdentities:
            - '@auth:role=enforcer'
          authorizedNamespace: $TARGET_NS
          authorizedSubnets: []
          name: Authorize Azure Defender to access Segment Console
          propagate: true
          subject:
            - - '@auth:realm=azureidentitytoken'
              - "$ID_TAG"
EOF
----
. Access the target host, such as via SSH.
. Set the `TARGET_NS` environment variable again on the target host. An
example follows.
+
[source,console]
----
export TARGET_NS=/acme/team-a/dev
----
. Set a `PCC_CONSOLE_URL` environment variable containing the full
address of the PCC Console and a `PCC_CONSOLE` environment variable
containing just its domain name or IP address. Examples follow.
+
[source,console]
----
export PCC_CONSOLE_URL=https://pcc.acme.com:8083
export PCC_CONSOLE=pcc.acme.com
----
. Ensure that the PCC Console is accessible from the target host.
+
[source,console]
----
ping $PCC_CONSOLE
----
. Save your PCC console user name and password under the following
environment variables.
+
[source,console]
----
export PCC_USER_NAME=aoperator
export PCC_USER_PASSWORD=12345
----
. Obtain a token from the Prisma Cloud Compute Console API and save it
under a `PCC_TOKEN` environment variable. The following command
accomplishes this with a very useful and lightweight utility called
https://stedolan.github.io/jq/download/[jq].
+
[source,console]
----
export PCC_TOKEN=$( curl -k -H "Content-Type: application/json" \
    -d '{"username":"'"$PCC_USER_NAME"'", "password":"'"$PCC_USER_PASSWORD"'"}' \
    $PCC_CONSOLE_URL/api/v1/authenticate \
    | jq -r  '.token' ) 
echo $PCC_TOKEN
----
+
NOTE: The token is good for twenty-four hours.
. Execute one of the following commands to install the Defender.
* *Service*: deploys the Defender as a Linux service and creates a
processing unit that represents the host, allowing you to control and
monitor all host communications.
+
[source,console]
----
curl -sSL -k --header \
     "authorization: Bearer $PCC_TOKEN" \
     -X POST $PCC_CONSOLE_URL/api/v1/scripts/defender.sh -d \
     '{"segmentation":{"registrationType":"auto","namespace":"'"$TARGET_NS"'"}}' \
     | sudo bash -s -- -c "$PCC_CONSOLE" -d "none" --install-host
----
* *Container*: deploys the Defender as a container and creates
processing units for all containers on the host, allowing you to control
and monitor all container communications.
+
[source,console]
----
curl -sSL -k --header \
     "authorization: Bearer $PCC_TOKEN" \
     -X POST $PCC_CONSOLE_URL/api/v1/scripts/defender.sh -d \
     '{"segmentation":{"registrationType":"auto","namespace":"'"$TARGET_NS"'"}}' \
     | sudo bash -s -- -c "$PCC_CONSOLE" -d "none" -g
----
+
TIP: Segment automatically assigns tags to Defenders to help you
identify them. If you want to add additional tags, you can pass them in
the `"tags"` array. Example:
`'{"segmentation":{"registrationType":"auto","namespace":"'"$TARGET_NS"'","tags":["type=service","auth=cloud"]}}'`
. Check the status of the Defender.
* *Service*
+
[source,console]
----
sudo systemctl status twistlock-defender-server.service
----
* *Container*
+
[source,console]
----
sudo docker ps
----
. In the PCC Console web interface, expand *Manage*, select *Defenders*,
and select *Manage*.
. You should see the Defender you just deployed with a status of
*Connected*.
. In the Segment Console web interface, expand *Manage* and select
*Defenders*.
. Either navigate to the namespace of the Defender or toggle *Recursive*
to on.
. The Defender you just deployed should be listed with a status of
*Connected*.

=== Advanced on-premise deployment

NOTE: You can use either
https://docs.paloaltonetworks.com/prisma/prisma-cloud/20-08/prisma-cloud-compute-edition-admin/api/access_api.html[basic
authentication or client certificates] to authenticate to the PCC
Console API. In this procedure, we use basic authentication.

[arabic]
. From your local host with `apoctl`, generate an app credential with
the `enforcer` role.
+
[source,shell]
----
apoctl appcred create enforcerd --role @auth:role=enforcer > enforcerd.creds
----
. Use the following command to obtain a token with the desired
restrictions. At a minimum, we recommend restricting the length of its
validity and role. You can also require the Defender to register in a
specified namespace or make its request from a specific subnet.
* *Syntax*:
+
[source,console]
----
apoctl auth appcred --path enforcerd.creds \
       --restrict-role @auth:role=enforcer \
       --validity <golang-duration> \
       [--restrict-namespace <segment-namespace>] \
       [--restrict-network <cidr>]
----
* *Fully restricted example*:
+
[source,console]
----
apoctl auth appcred --path enforcerd.creds \
       --restrict-namespace /acme/team-a/dev \
       --restrict-role @auth:role=enforcer \
       --restrict-network 10.0.0.0/8 \
       --validity 10m
----
* *Minimally restricted example*:
+
[source,console]
----
apoctl auth appcred --path enforcerd.creds \
       --restrict-role @auth:role=enforcer --validity 10m
----
. This should return a base64-encoded JSON web token (JWT). Copy the
value.
. Access the target host, such as via SSH.
. Set a `SEG_TOKEN` environment variable and paste the token value you
copied.
+
[source,console]
----
export SEG_TOKEN=eyJhbGciOiJFUzI1NiIsInR5cCI6IkpXVCJ9.eyJyZWFsbSI6IkNlcnRpZmljYXRlIiwiZGF0YSI6eyJjb21tb25OYW1lIjoiYXBwOmNyZWRlbnRpYWw6NWYxMjE1NjlmMGZlMTcwODJjOGNhNzYwOmVuZm9yY2VyZCIsIm9yZ2FuaXphdGlvbiI6Ii9hY21lIiwicmVhbG0iOiJjZXJ0aWZpY2F0ZSIsInNlcmlhbE51bWJlciI6IjExOTQzODAyMzcyMTkyNzY3MjIyOTMwODU0ODc5NzM3MTEwNzg0MSIsInN1YmplY3QiOiIxMTk0MzgwMjM3MjE5Mjc2NzIyMjkzMDg1NDg3OTczNzExMDc4NDEifSwicmVzdHJpY3Rpb25zIjp7InBlcm1zIjpbIkBhdXRoOnJvbGU9ZW5mb3JjZXIiXX0sImV4cCI6MTU5NTAyNDMzMCwiaWF0IjoxNTk1MDE5NTMwLCJpc3MiOiJodHRwczovLzM0LjgyLjE1My4yMzg6NDQ0MyIsInN1YiI6IjExOTQzODAyMzcyMTkyNzY3MjIyOTMwODU0ODc5NzM3MTEwNzg0MSJ9.0K9Y_HEbPKnvGsZsWjGMPtIn14Gt46vxg4GxlCiNzjc7xgbO0XQVfzXtTV1mC3i2fzey_VPxnQ1Ss0tS0ieE7g
----
. Set a `PCC_CONSOLE_URL` environment variable containing the full
address of the PCC Console and a `PCC_CONSOLE` environment variable
containing just its domain name or IP address. Examples follow.
+
[source,console]
----
export PCC_CONSOLE_URL=https://pcc.acme.com:8083
export PCC_CONSOLE=pcc.acme.com
----
. Ensure that the PCC Console is accessible from the target host.
+
[source,console]
----
ping $PCC_CONSOLE
----
. Set a `TARGET_NS` environment variable containing the Segment
namespace for this Defender. This should be a great grandchild
namespace. An example follows.
+
[source,console]
----
export TARGET_NS=/acme/team-a/dev/vm1
----
. Save your PCC console user name and password under the following
environment variables.
+
[source,console]
----
export PCC_USER_NAME=aoperator
export PCC_USER_PASSWORD=12345
----
. Obtain a token from the Prisma Cloud Compute Console API and save it
under a `PCC_TOKEN` environment variable. The following command
accomplishes this with a very useful and lightweight utility called
https://stedolan.github.io/jq/download/[jq].
+
[source,console]
----
export PCC_TOKEN=$( curl -k -H "Content-Type: application/json" \
    -d '{"username":"'"$PCC_USER_NAME"'", "password":"'"$PCC_USER_PASSWORD"'"}' \
    $PCC_CONSOLE_URL/api/v1/authenticate \
    | jq -r  '.token' ) 
echo $PCC_TOKEN
----
+
NOTE: The token is good for twenty-four hours.
. Execute one of the following commands to install the Defender.
* *Service*: deploys the Defender as a Linux service and creates a
processing unit that represents the host, allowing you to control and
monitor all host communications.
+
[source,console]
----
curl -sSL -k --header \
     "authorization: Bearer $PCC_TOKEN" \
     -X POST $PCC_CONSOLE_URL/api/v1/scripts/defender.sh -d \
     '{"segmentation":{"registrationType":"ott","namespace":"'"$TARGET_NS"'","ott":"'"$SEG_TOKEN"'"}}' \
     | sudo bash -s -- -c "$PCC_CONSOLE" -d "none" --install-host
----
* *Container*: deploys the Defender as a container and creates
processing units for all containers on the host, allowing you to control
and monitor all container communications.
+
[source,console]
----
curl -sSL -k --header \
     "authorization: Bearer $PCC_TOKEN" \
     -X POST $PCC_CONSOLE_URL/api/v1/scripts/defender.sh -d \
     '{"segmentation":{"registrationType":"ott","namespace":"'"$TARGET_NS"'","ott":"'"$SEG_TOKEN"'"}}' \
     | sudo bash -s -- -c "$PCC_CONSOLE" -d "none" -g
----
+
TIP: Segment automatically assigns tags to Defenders to help you
identify them. If you want to add additional tags, you can pass them in
the `"tags"` array. Example:
`'{"segmentation":{"registrationType":"auto","namespace":"'"$TARGET_NS"'","tags":["type=container","auth=token"]}}'`
. Check the status of the Defender.
* *Service*
+
[source,console]
----
sudo systemctl status twistlock-defender-server.service
----
* *Container*
+
[source,console]
----
sudo docker ps
----
. In the PCC Console web interface, expand *Manage*, select *Defenders*,
and select *Manage*.
. Confirm that the Defender you just deployed is listed with a status of
*Connected*.
. In the Segment Console web interface, expand *Manage* and select
*Defenders*.
. Either navigate to the namespace of the Defender or toggle *Recursive*
to on.
. Confirm that the Defender you just deployed is listed with a status of
*Connected*.

=== Advanced flags

You can add the following flags to modify the Defender’s installation
defaults. When obtaining the command from the PCC Console web interface,
you paste the flags into the *Segment advanced flags* field separated by
spaces. When constructing the command yourself, you include them in the
`segmentation` object as values of the `advancedFlags` key. You can use
the web interface to understand the syntax.

[width="100%",cols="<27%,<73%",options="header",]
|===
|Flag |Description
|`--activate-control-plane-pus` |Pass this flag if you wish to recognize
the PCC and Segment Consoles as processing units, allowing their
communications to be monitored and controlled. By default, the Segment
Defender ignores them.

|`--application-proxy-port` |Start of the port range for ports used by
Segment Defender application proxy. You may adjust this if you
experience conflicts.

|`--cloud-probe-timeout` |Segment Defender can determine if it is
running in a cloud environment, such as AWS, GCP, or Azure. This is the
maximum amount of time to wait for these internal probes to complete.
Default is two seconds.

|`--disable-dns-proxy` |Segment Defender DNS proxy allows policies to be
written based on FQDN, in cases where an exact IP address may be
unpredictable. This is on by default.

|`--dns-server-address` |DNS server address or CIDR that is observed by
Segment Defender DNS proxy. The default is `0.0.0.0/0`.

|`--enable-ebpf` |(*Beta*) Pass this flag to gain performance
improvements by using extended Berkeley Packet Filter (eBPF) on systems
that support it.

|`--enable-ipv6` |(*Beta*) The Segment defender ignores IPv6
communications by default. If you have IPv6 enabled and wish to monitor
and control these connections, pass this flag.

|`--log-level` |Minimum logging level, which is `info` by default. Other
options include `debug`, `trace`, and `warn`.

|`--working-dir` |A persistent w/r/e working directory. Files such as
logs are stored here.
|===
