// WE PULL THIS CONTENT FROM https://github.com/aporeto-inc/junon
// DO NOT EDIT THIS FILE.
// YOU MUST SUBMIT A PR AGAINST THE UPSTREAM REPO.
// THE UPSTREAM REPO IS CURRENTLY PRIVATE.

== Windows host

=== About installing Defenders on Windows hosts

Before you begin, ensure that you meet the link:../reqs[system
requirements].

To install the Defender on a Windows host, you must retrieve and execute
our PowerShell script from the target host. We provide three options.

* link:#quick-deployment[Quick deployment]: use the web interface to
obtain the command, then execute it from the target host. Prisma Cloud
Compute (PCC) Console creates and passes an app credential to the
Defender. The Defender uses the app credential to communicate with the
Segment Console API.
* link:#advanced-cloud-deployment[Advanced cloud deployment]:
recommended for production AWS, GCP, and Azure hosts. The Defender uses
short-lived tokens from the cloud provider to authenticate to Segment
Console. We provide a PowerShell-based procedure to facilitate
automation.
* link:#advanced-on-premise-deployment[Advanced on-premise deployment]:
an advanced method of deploying the Defender to on-premise production
hosts. You create a restricted token for the Segment Defender. It
exchanges the token for an app credential. We provide a PowerShell-based
procedure to facilitate automation.

=== Quick deployment

[arabic]
. From the PCC Console web interface, expand *Manage*, select
*Defenders*, select *Deploy*, and select *Single Defender*.
. In the first drop-down, select an address of Segment Console that the
target host can access.
. Select *Host Defender - Windows* as the *Defender type*.
. Leave the *Listener type* set to *None*.
+
IMPORTANT: Segment does not support the
https://docs.paloaltonetworks.com/prisma/prisma-cloud/20-08/prisma-cloud-compute-edition-admin/access_control/rbac.html[TCP
listener type]. Selecting *TCP* can cause the Defender to block
connections in an unpredictable manner.
. Ensure that *Segment* is toggled *On*.
. Under *registration type*, select *App credentials*.
. In the *namespace* field, type the namespace that you want to deploy
the Defender to. This should be a great grandchild namespace. Example:
`/acme/team-a/dev/vm1`
+
IMPORTANT: Ensure that you type the namespace correctly and that you
have permissions to deploy the Defender there. The PCC Console performs
no validation on your entries.
. You should be able to leave *Advanced flags* blank. Refer to
link:#advanced-flags[Advanced flags] if you’re interested in learning
about these options.
. Access the target host, such as via SSH.
. Copy the script from the web interface and execute it from a 64-bit
PowerShell on the target host.
. Check the status of the Defender.
+
[source,powershell]
----
sc.exe query "twistlockDefender"
----
. In the PCC Console web interface, expand *Manage*, select *Defenders*,
and select *Manage*.
. You should see the Defender you just deployed with a status of
*Connected*.
. In the Segment Console web interface, expand *Manage* and select
*Defenders*.
. Either navigate to the namespace of the Defender or toggle *Recursive*
to on.
. The Defender you just deployed should be listed with a status of
*Connected*.

=== Advanced cloud deployment

You can use either
https://docs.paloaltonetworks.com/prisma/prisma-cloud/20-08/prisma-cloud-compute-edition-admin/api/access_api.html[basic
authentication or client certificates] to authenticate to the Prisma
Cloud Compute (PCC) Console API. In this procedure, we use basic
authentication. You’ll perform some preliminary steps from your local
host where `apoctl` is installed. We assume that your local host is
running Linux or macOS.

[arabic]
. Ensure that the target host has one of the following.
* *AWS*:
https://aws.amazon.com/blogs/security/easily-replace-or-attach-an-iam-role-to-an-existing-ec2-instance-by-using-the-ec2-console/[an
IAM role attached] with read-only access to tags
(https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-policy-structure.html[`ec2:DescribeTags`])
* *GCP*:
https://cloud.google.com/compute/docs/access/create-enable-service-accounts-for-instances[GCP
service account attached]
* *Azure*:
https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/qs-configure-portal-windows-vmss[assigned
a managed identity]
. Construct a link:../../../concepts/#tags-and-identity[Segment tag]
containing the cloud metadata that identifies Defenders authorized to
register with Segment. The tag must begin with `@auth:` followed by a
key-value pair. Refer to the table below for some common examples.
+
[width="99%",cols="<12%,<25%,<25%,<38%",options="header",]
|===
|Cloud provider |Value |Segment tag syntax |Segment tag example
|AWS |AWS account ID* |`@auth:account=<AWS_ACCOUNT_ID>`
|`@auth:account=942613894219`

|GCP |GCP project ID |`@auth:projectid=<GCP_PROJECT_ID>`
|`@auth:projectid=acme-dev`

|Azure |Microsoft tenant ID† |`@auth:tenantid=<TENANT_ID>`
|`@auth:tenantid=cd629cb5-2826-4126-82fd-3f2df5f5bc7`

|GCP and Azure |Name of organization
|`@auth:organization=<ORGANIZATION>` |`@auth:organization=acme`
|===
+
pass:[*] _You can find your AWS account ID under_ *My security credentials* _in
the AWS Management Console._
+
† _To learn how to find your tenant ID, refer to the_
https://techcommunity.microsoft.com/t5/Office-365/How-do-you-find-the-tenant-ID/td-p/89018[Microsoft
documentation].
. On your local host equipped with `apoctl`, set an `ID_TAG` environment
variable. If the target host is on AWS, also set a `ROLE_TAG`
environment variable.
* `ID_TAG` containing the Segment tag you’ve constructed to identify
authorized Defenders
* `ROLE_TAG` (AWS only) containing the name of the IAM role attached to
the instance prepended with `@auth:rolename=`
+
Some examples follow.
* *AWS*:
+
[source,console]
----
export ID_TAG="@auth:account=942913894219"
export ROLE_TAGE="@auth:rolename=segment"
----
* *GCP*:
+
[source,console]
----
export ID_TAG="@auth:projectid=acme-dev"
----
* *Azure*:
+
[source,console]
----
export ID_TAG="@auth:tenantid=cd629cb5-2826-4126-82fd-3f2df5f5bc7"
----
. Set a `TARGET_NS` environment variable containing the Segment
namespace for this Defender. This should be a grandchild namespace. An
example follows.
+
[source,console]
----
export TARGET_NS=/acme/team-a/dev
----
. Create an API authorization that allows the Defender to access the
Segment Console. Use the command that corresponds to the cloud provider
of the target host.
* *AWS*
+
[source,console]
----
cat << EOF | apoctl api import -f -
APIVersion: 0
label: ec2-defender-auth
data:
      apiauthorizationpolicies:
        - authorizedIdentities:
            - '@auth:role=enforcer'
          authorizedNamespace: $TARGET_NS
          authorizedSubnets: []
          name: Authorize EC2 Defender to access Segment Console
          propagate: true
          subject:
            - - '@auth:realm=awssecuritytoken'
              - "$ID_TAG"
              - "$ROLE_TAG"
EOF
----
* *GCP*
+
[source,console]
----
cat << EOF | apoctl api import -f -
APIVersion: 0
label: gcp-defender-auth
data:
      apiauthorizationpolicies:
        - authorizedIdentities:
            - '@auth:role=enforcer'
          authorizedNamespace: $TARGET_NS
          authorizedSubnets: []
          name: Authorize GCP Defender to access Segment Console
          propagate: true
          subject:
            - - '@auth:realm=gcpidentitytoken'
              - "$ID_TAG"
EOF
----
* *Azure*
+
[source,console]
----
cat << EOF | apoctl api import -f -
APIVersion: 0
label: azure-defender-auth
data:
      apiauthorizationpolicies:
        - authorizedIdentities:
            - '@auth:role=enforcer'
          authorizedNamespace: $TARGET_NS
          authorizedSubnets: []
          name: Authorize Azure Defender to access Segment Console
          propagate: true
          subject:
            - - '@auth:realm=azureidentitytoken'
              - "$ID_TAG"
EOF
----
. Access the target host, such as by opening a Remote Desktop (RDP)
session.
. Open a 64-bit PowerShell terminal and create a JSON object stored in a
`SEGMENT` variable as follows. Replace `<SEGMENT-NAMESPACE>` with the
target Segment namespace of this Defender. This should be a great
grandchild namespace. Example: `/acme/team-a/dev/vm1`
+
[source,powershell]
----
$SEGMENT = @"
{
   "segmentation":{
      "registrationType":"auto",
      "namespace":"<SEGMENT-NAMESPACE>"
   }
}
"@ | ConvertFrom-Json
----
+
TIP: Segment automatically assigns tags to Defenders to help you
identify them. If you want to add additional tags, you can add a
`"tags"` array to the `segmentation` object. Example:
`"tags":["type=service","auth=cloud"]`
. Save your PCC console user name and password in a `CREDS` variable.
+
[source,powershell]
----
$CREDS = @{"username"="aoperator";"password"="12345";}
----
. Set a `PCC_CONSOLE_URL` variable containing the full address of the
PCC Console and a `PCC_CONSOLE` variable containing just its domain name
or IP address. Examples follow.
+
[source,powershell]
----
$PCC_CONSOLE_URL = 'https://pcc.acme.com:8083'
$PCC_CONSOLE = 'pcc.acme.com'
----
. Ensure that the PCC Console is accessible from the target host.
+
[source,powershell]
----
ping $PCC_CONSOLE
----
. Obtain a token from the PCC Console API and save it in a `PCC_TOKEN`
variable.
+
[source,powershell]
----
add-type "using System.Net; `
using System.Security.Cryptography.X509Certificates; `
public class TrustAllCertsPolicy : ICertificatePolicy{ public bool `
  CheckValidationResult(ServicePoint srvPoint, `
    X509Certificate certificate, WebRequest request, int certificateProblem) `
    { return true; }}"; `
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; `
    [System.Net.ServicePointManager]::CertificatePolicy = New-Object `
    TrustAllCertsPolicy; `
$PCC_TOKEN = (Invoke-RestMethod -Uri $PCC_CONSOLE_URL/api/v1/authenticate `
-Body ($CREDS|ConvertTo-Json) -ContentType "application/json" `
-Method Post).token 
----
+
TIP: If your PCC Console uses trusted certificates, you can omit the
first nine lines.
+
NOTE: The token is good for twenty-four hours.
. Execute the following command to install the Defender.
+
[source,powershell]
----
add-type "using System.Net; `
using System.Security.Cryptography.X509Certificates; `
public class TrustAllCertsPolicy : ICertificatePolicy{ public bool `
  CheckValidationResult(ServicePoint srvPoint, `
    X509Certificate certificate, WebRequest request, int certificateProblem) `
    { return true; }}"; `
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; `
    [System.Net.ServicePointManager]::CertificatePolicy = New-Object `
    TrustAllCertsPolicy; 
Invoke-WebRequest -Uri "$PCC_CONSOLE_URL/api/v1/scripts/defender.ps1" `
    -Body ($SEGMENT|ConvertTo-Json) `
    -Method Post -Headers @{"authorization" = "Bearer $PCC_TOKEN" } `
    -OutFile defender.ps1; .\defender.ps1 -type serverWindows `
    -consoleCN $PCC_CONSOLE -install 
----
+
TIP: If your PCC Console uses trusted certificates, you can omit the
first nine lines.
. Check the status of the Defender.
+
[source,powershell]
----
sc.exe query "twistlockDefender"
----
. In the PCC Console web interface, expand *Manage*, select *Defenders*,
and select *Manage*.
. You should see the Defender you just deployed with a status of
*Connected*.
. In the Segment Console web interface, expand *Manage* and select
*Defenders*.
. Either navigate to the namespace of the Defender or toggle *Recursive*
to on.
. The Defender you just deployed should be listed with a status of
*Connected*.

=== Advanced on-premise deployment

You can use either
https://docs.paloaltonetworks.com/prisma/prisma-cloud/20-08/prisma-cloud-compute-edition-admin/api/access_api.html[basic
authentication or client certificates] to authenticate to the Prisma
Cloud Compute (PCC) Console API. In this procedure, we use basic
authentication. You’ll perform some preliminary steps from your local
host where `apoctl` is installed. We assume that your local host is
running Linux or macOS.

[arabic]
. From your local host with `apoctl`, generate an app credential with
the `enforcer` role.
+
[source,shell]
----
apoctl appcred create enforcerd --role @auth:role=enforcer > enforcerd.creds
----
. Use the following command to obtain a token with the desired
restrictions. At a minimum, we recommend restricting the length of its
validity and role. You can also require the Defender to register in a
specified namespace or make its request from a specific subnet.
* *Syntax*:
+
[source,console]
----
apoctl auth appcred --path enforcerd.creds \
       --restrict-role @auth:role=enforcer \
       --validity <golang-duration> \
       [--restrict-namespace <segment-namespace>] \
       [--restrict-network <cidr>]
----
* *Fully restricted example*:
+
[source,console]
----
apoctl auth appcred --path enforcerd.creds \
       --restrict-namespace /acme/team-a/dev \
       --restrict-role @auth:role=enforcer \
       --restrict-network 10.0.0.0/8 \
       --validity 10m
----
* *Minimally restricted example*:
+
[source,console]
----
apoctl auth appcred --path enforcerd.creds \
       --restrict-role @auth:role=enforcer --validity 10m
----
. This should return a base64-encoded JSON web token (JWT). Copy the
value.
. Access the target host, such as by opening a Remote Desktop (RDP)
session.
. Open a 64-bit PowerShell terminal and create a JSON object stored in a
`SEGMENT` variable as follows. Replace `<PASTE-TOKEN>` with the value of
the token you copied in the previous step. Replace `<SEGMENT-NAMESPACE>`
with the target Segment namespace of this Defender. This should be a
great grandchild namespace. Example: `/acme/team-a/dev/vm1`
+
[source,powershell]
----
$SEGMENT = @"
{
   "segmentation":{
      "registrationType":"ott",
      "namespace":"<SEGMENT-NAMESPACE>",
      "ott":"<PASTE-TOKEN>"
   }
}
"@ | ConvertFrom-Json
----
+
TIP: Segment automatically assigns tags to Defenders to help you
identify them. If you want to add additional tags, you can add a
`"tags"` array to the `segmentation` object. Example:
`"tags":["type=service","auth=cloud"]`
. Save your PCC Console user name and password in a `CREDS` variable.
+
[source,powershell]
----
$CREDS = @{"username"="aoperator";"password"="12345";}
----
. Set a `PCC_CONSOLE_URL` environment variable containing the full
address of the PCC Console and a `PCC_CONSOLE` environment variable
containing just its domain name or IP address. Examples follow.
+
[source,powershell]
----
$PCC_CONSOLE_URL = 'https://pcc.acme.com:8083'
$PCC_CONSOLE = 'pcc.acme.com'
----
. Ensure that the PCC Console is accessible from the target host.
+
[source,powershell]
----
ping $PCC_CONSOLE
----
. Obtain a token from the PCC Console API and save it in a `PCC_TOKEN`
variable.
+
[source,powershell]
----
add-type "using System.Net; `
using System.Security.Cryptography.X509Certificates; `
public class TrustAllCertsPolicy : ICertificatePolicy{ public bool `
  CheckValidationResult(ServicePoint srvPoint, `
    X509Certificate certificate, WebRequest request, int certificateProblem) `
    { return true; }}"; `
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; `
    [System.Net.ServicePointManager]::CertificatePolicy = New-Object `
    TrustAllCertsPolicy; `
$PCC_TOKEN = (Invoke-RestMethod -Uri $PCC_CONSOLE_URL/api/v1/authenticate `
-Body ($CREDS|ConvertTo-Json) -ContentType "application/json" `
-Method Post).token 
----
+
TIP: If your PCC Console uses trusted certificates, you can omit the
first nine lines.
+
NOTE: The token is good for twenty-four hours.
. Execute the following command to install the Defender.
+
[source,powershell]
----
add-type "using System.Net; `
using System.Security.Cryptography.X509Certificates; `
public class TrustAllCertsPolicy : ICertificatePolicy{ public bool `
  CheckValidationResult(ServicePoint srvPoint, `
    X509Certificate certificate, WebRequest request, int certificateProblem) `
    { return true; }}"; `
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; `
    [System.Net.ServicePointManager]::CertificatePolicy = New-Object `
    TrustAllCertsPolicy; 
Invoke-WebRequest -Uri "$PCC_CONSOLE_URL/api/v1/scripts/defender.ps1" `
    -Body ($SEGMENT|ConvertTo-Json) `
    -Method Post -Headers @{"authorization" = "Bearer $PCC_TOKEN" } `
    -OutFile defender.ps1; .\defender.ps1 -type serverWindows `
    -consoleCN $PCC_CONSOLE -install 
----
+
TIP: If your PCC Console uses trusted certificates, you can omit the
first nine lines.
. Check the status of the Defender.
+
[source,powershell]
----
sc.exe query "twistlockDefender"
----
. In the PCC Console web interface, expand *Manage*, select *Defenders*,
and select *Manage*.
. Confirm that the Defender you just deployed is listed with a status of
*Connected*.
. In the Segment Console web interface, expand *Manage* and select
*Defenders*.
. Either navigate to the namespace of the Defender or toggle *Recursive*
to on.
. Confirm that the Defender you just deployed is listed with a status of
*Connected*.

=== Advanced flags

You can add the following flags to modify the Defender’s installation
defaults. When obtaining the command from the PCC Console web interface,
you paste the flags into the *Segment advanced flags* field separated by
spaces. When constructing the command yourself, you include them in the
`segmentation` object as values of the `advancedFlags` key. You can use
the web interface to understand the syntax.

[width="100%",cols="<27%,<73%",options="header",]
|===
|Flag |Description
|`--activate-control-plane-pus` |Pass this flag if you wish to recognize
the PCC and Segment Consoles as processing units, allowing their
communications to be monitored and controlled. By default, the Segment
Defender ignores them.

|`--application-proxy-port` |Start of the port range for ports used by
Segment Defender application proxy. You may adjust this if you
experience conflicts.

|`--cloud-probe-timeout` |Segment Defender can determine if it is
running in a cloud environment, such as AWS, GCP, or Azure. This is the
maximum amount of time to wait for these internal probes to complete.
Default is two seconds.

|`--disable-dns-proxy` |Segment Defender DNS proxy allows policies to be
written based on FQDN, in cases where an exact IP address may be
unpredictable. This is on by default.

|`--dns-server-address` |DNS server address or CIDR that is observed by
Segment Defender DNS proxy. The default is `0.0.0.0/0`.

|`--enable-ebpf` |(*Beta*) Pass this flag to gain performance
improvements by using extended Berkeley Packet Filter (eBPF) on systems
that support it.

|`--enable-ipv6` |(*Beta*) The Segment defender ignores IPv6
communications by default. If you have IPv6 enabled and wish to monitor
and control these connections, pass this flag.

|`--log-level` |Minimum logging level, which is `info` by default. Other
options include `debug`, `trace`, and `warn`.

|`--working-dir` |A persistent w/r/e working directory. Files such as
logs are stored here.
|===
