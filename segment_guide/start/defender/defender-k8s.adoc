// WE PULL THIS CONTENT FROM https://github.com/aporeto-inc/junon
// DO NOT EDIT THIS FILE.
// YOU MUST SUBMIT A PR AGAINST THE UPSTREAM REPO.
// THE UPSTREAM REPO IS CURRENTLY PRIVATE.

== Kubernetes

=== Overview

Segment provides a close integration with Kubernetes to make it easy to
control and monitor clusters composed of Linux hosts. Use `twistcli` to
create either a `DaemonSet` or Helm chart to deploy your Defenders.

=== Prerequisites

* `apoctl` installed and configured
* Logged into `apoctl` with the `namespace.administrator` role
* Kubernetes cluster that meets the system requirements
* `kubectl` installed and configured to point to your target cluster

IMPORTANT: By default, the `kubectl` installed by GKE does not have the
`container.clusterRoleBindings.create` permission, which is required.
Refer to the
https://cloud.google.com/kubernetes-engine/docs/how-to/role-based-access-control[Google
documentation] for more information. One way around this is to create a
cluster using the `--enable-basic-auth` flag. Run
`gcloud container clusters describe <cluster-name>` and look for the
`password` value. Run
`kubectl config set-credentials cluster-admin --user=admin --password=<password-value>`
to set the password in your configuration file. Then run
`kubectl config set-context --current --user=cluster-admin` to configure
your current context to use this user account.

=== Install twistcli

If you don’t already have `twistcli` installed, complete the following
steps.

[arabic]
. Set a `PCC_CONSOLE_URL` environment variable containing the full
address of the Prisma Cloud Compute (PCC) Console including its port.
+
TIP: If your PCC Console is running on Kubernetes, you can discover its
address with `kubectl get service -o wide -n twistlock`
+
[source,console]
----
export PCC_CONSOLE_URL=https://pcc.acme.com:8083
----
. Set the following environment variables containing your PCC
credentials.
+
[source,console]
----
export PCC_USER_NAME=aoperator
export PCC_USER_PASSWORD=12345
----
. Obtain a token from PCC and save it under a `PCC_TOKEN` environment
variable. The following command accomplishes this with a very useful and
lightweight utility called https://stedolan.github.io/jq/download/[jq].
+
[source,console]
----
export PCC_TOKEN=$( curl -k -H "Content-Type: application/json" \
      -d '{"username":"'"$PCC_USER_NAME"'", "password":"'"$PCC_USER_PASSWORD"'"}' \
      $PCC_CONSOLE_URL/api/v1/authenticate \
      | jq -r  '.token' ) 
echo $PCC_TOKEN
----
. Use one of the following commands to download and install `twistcli`.
* *macOS*
+
[source,console]
----
sudo curl -o /usr/local/bin/twistcli -L -k \
      --header "authorization: Bearer $PCC_TOKEN" \
      $PCC_CONSOLE_URL/api/v1/util/osx/twistcli &&
sudo chmod 755 /usr/local/bin/twistcli
----
* *Linux*
+
[source,console]
----
sudo curl -o /usr/local/bin/twistcli -L -k \
      --header "authorization: Bearer $PCC_TOKEN" \
      $PCC_CONSOLE_URL/api/v1/util/twistcli &&
sudo chmod 755 /usr/local/bin/twistcli
----

TIP: To learn more about `twistcli`, refer to the
https://docs.paloaltonetworks.com/prisma/prisma-cloud/20-08/prisma-cloud-compute-edition-admin/tools/twistcli.html[Prisma
Cloud Compute documentation].

=== Define the deployment

[arabic]
. Set a `SEGMENT_NS` environment variable identifying the Segment
namespace for this cluster. This should be a grandchild namespace.
+
[source,console]
----
export SEGMENT_NS=/acme/team-a/dev
----
. Create a Kubernetes namespace for your Defender pods.
+
[source,console]
----
kubectl create namespace pcc
----
. Set a `PCC_CONSOLE` environment variable containing the address of the
PCC Console. If you’re deploying Defenders to the same cluster as the
PCC Console, use `twistlock-console`. Otherwise, use either the domain
name (preferred) or external IP address of PCC Console.
* *Defenders in same cluster as PCC Console*
+
[source,console]
----
export PCC_CONSOLE=twistlock-console
----
* *Defenders not in same cluster as PCC Console*
+
[source,console]
----
export PCC_CONSOLE=pcc.acme.com
----
. Use one of the following commands to define your deployment.
* *DaemonSet*
+
[source,console]
----
twistcli defender export kubernetes \
      --address $PCC_CONSOLE_URL \
      --cluster-address $PCC_CONSOLE \
      --user $PCC_USER_NAME \
      --password $PCC_USER_PASSWORD \
      --segmentation-namespace $SEGMENT_NS \
      --namespace pcc
----
* *Helm chart*
+
[source,console]
----
twistcli defender export kubernetes \
      --address $PCC_CONSOLE_URL \
      --cluster-address $PCC_CONSOLE \
      --user $PCC_USER_NAME \
      --password $PCC_USER_PASSWORD \
      --segmentation-namespace $SEGMENT_NS \
      --namespace pcc \
      --helm
----
+
NOTE: Including the `--segmentation-namespace` flag enables Segment on
the Defenders.
+
TIP: Try `twistcli defender export kubernetes -h` to learn more about
the flags. If you want to customize the Segment features, you can use
the `--segmentation-flags` flag. To learn more about these, refer to
link:#advanced-flags[Advanced flags].
. (Optional) If you are managing your own Kubernetes cluster and wish to
deploy the Defenders on the master nodes, you must add the following
toleration. You can open the `DaemonSet` file in your editor and make
this change. If you are using Helm, you must unpack the Helm chart.
+
[source,console]
----
tolerations:
- key: "node-role.kubernetes.io/master"
  operator: "Exists"
  effect: "NoSchedule"
----

=== Deploy the Defenders

[arabic]
. Use one of the following commands to deploy the Defenders to your
target cluster.
* *DaemonSet*
+
[source,console]
----
kubectl apply -f defender.yaml
----
* *Helm chart*
+
[source,console]
----
helm install twistlock-defender-ds \
     ./twistlock-defender-helm.tar.gz
----
. To confirm your deployment, issue the following command.
+
[source,console]
----
kubectl get pods --namespace pcc
----
. You should see a `twistlock-defender` pod for each node in your
cluster, all with a status of `Running`.
+
[source,console]
----
NAME                          READY   STATUS    RESTARTS   AGE
twistlock-defender-ds-gsznf   1/1     Running   0          65s
twistlock-defender-ds-r95kv   1/1     Running   0          65s
twistlock-defender-ds-znsv4   1/1     Running   0          65s
----
. Open the PCC Console web interface, expand *Manage* and select
*Defenders*. You should see the Defenders listed with a status of
*Connected*.
. Open the Segment Console web interface, expand *Manage* and select
*Defenders*. Either navigate to the namespace of your cluster or toggle
*Recursive* to *On*. You should see the Defenders listed with a status
of *Connected*.
+
Great job! Segment now recognizes the pods in your cluster as processing
units, allowing you to control and monitor their traffic. It ignores the
Defender pods. It also ignores `kube-system` pods by default.
. If you have pods running, select *Platform* in the Segment Console web
interface and toggle *Recursive* to *On*. The pods should appear, with
their traffic shown as dashed green lines.

=== Advanced flags

Segment offers a few advanced flags that allow you to modify the
Defender’s installation defaults. You can pass these as the values of
`--segmentation-flags <FLAG1> <FLAG2>`.

[width="100%",cols="<27%,<73%",options="header",]
|===
|Flag |Description
|`--activate-control-plane-pus` |Pass this flag if you wish to recognize
the PCC and Segment Consoles as processing units, allowing their
communications to be monitored and controlled. By default, the Segment
Defender ignores them.

|`--activate-kube-system-pus` |Pass this flag if you wish to recognize
containers in the `kube-system` namespace as processing units, allowing
their communications to be monitored and controlled. By default, the
Segment Defender ignores them.

|`--activate-openshift-pus` |Pass this flag if you wish to recognize
containers in Kubernetes namespaces starting with `openshift-` as
processing units, allowing their communications to be monitored and
controlled. By default, the Segment Defender ignores them.

|`--application-proxy-port` |Start of the port range for ports used by
Segment Defender application proxy. You may adjust this if you
experience conflicts.

|`--cloud-probe-timeout` |Segment Defender can determine if it is
running in a cloud environment, such as AWS, GCP, or Azure. This is the
maximum amount of time to wait for these internal probes to complete.
Default is two seconds.

|`--disable-dns-proxy` |Segment Defender DNS proxy allows policies to be
written based on FQDN, in cases where an exact IP address may be
unpredictable. This is on by default.

|`--dns-server-address` |DNS server address or CIDR that is observed by
Segment Defender DNS proxy. The default is `0.0.0.0/0`.

|`--enable-ebpf` |(*Beta*) Pass this flag to gain performance
improvements by using extended Berkeley Packet Filter (eBPF) on systems
that support it.

|`--enable-ipv6` |(*Beta*) The Segment Defender ignores IPv6
communications by default. If you have IPv6 enabled and wish to monitor
and control these connections, pass this flag.

|`--kubeconfig` |Path to kubeconfig. Can be used if not using an
in-cluster config.

|`--kubenode` |Provides a way to specify the Kubernetes node name. This
can be useful for filtering.

|`--log-level` |Minimum logging level, which is `info` by default. Other
options include `debug`, `trace`, and `warn`.

|`--working-dir` |A persistent w/r/e working directory. Files such as
logs are stored here.
|===
